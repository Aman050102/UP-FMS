<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>สร้างคิวอาร์เข้าใช้สนาม (นับจำนวนอย่างเดียว)</title>
    <meta name="color-scheme" content="light dark">
    <link rel="icon" href="./favicon.png" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --purple: #6f4ab4;
            --bg: #efe8f7;
            --card: #fff;
            --text: #1d1b22;
            --muted: #6a6570;
            --divider: #ece7f3;
            --shadow: 0 10px 30px rgba(55, 36, 107, .12)
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans Thai", Roboto, Arial, sans-serif;
            color: var(--text);
            background: linear-gradient(180deg, var(--purple) 0 80px, var(--bg) 80px 100%)
        }

        main {
            padding: 18px;
            display: grid;
            gap: 18px
        }

        .card {
            background: var(--card);
            border-radius: 22px;
            box-shadow: var(--shadow);
            padding: 16px
        }

        .row {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 10px;
            align-items: center
        }

        input[type=text],
        input[type=date],
        select {
            padding: 10px 12px;
            border: 1px solid var(--divider);
            border-radius: 12px;
            font-weight: 600;
            width: 100%
        }

        .chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .chip {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid var(--divider);
            cursor: pointer;
            font-weight: 700
        }

        .chip.selected {
            outline: 3px solid currentColor;
            outline-offset: 2px
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        button {
            appearance: none;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--divider);
            background: #fff;
            font-weight: 800;
            cursor: pointer
        }

        .grid-qr {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px
        }

        .qrbox {
            background: #fff;
            border: 1px solid var(--divider);
            border-radius: 16px;
            padding: 12px;
            display: grid;
            gap: 8px
        }

        .qr-title {
            font-weight: 800;
            text-align: center
        }

        .hint {
            color: var(--muted);
            font-size: 13px
        }

        @media(max-width:980px) {
            .row {
                grid-template-columns: 1fr
            }

            .grid-qr {
                grid-template-columns: 1fr
            }
        }

        @media(prefers-color-scheme:dark) {
            :root {
                --bg: #1f1a29;
                --card: #221d2e;
                --text: #f6f1ff;
                --muted: #c7bfd3;
                --divider: #3a304b
            }

            button {
                background: #2a2338
            }
        }
    </style>
</head>

<body>
    <main>
        <section class="card">
            <h2>ตั้งค่าลิงก์ปลายทาง</h2>
            <p class="hint">สแกนแล้วจะไปที่ <code>/checkin</code> ของเซิร์ฟเวอร์ จากนั้นบันทึกจำนวนและเวลาเข้า</p>
            <div class="row"><label>Base URL</label><input id="base" type="text"
                    placeholder="https://sports.up.ac.th" /></div>
            <div class="row"><label>วันที่ (session)</label><input id="session" type="date" /></div>
            <div class="row"><label>ขนาดภาพ (px)</label>
                <select id="size">
                    <option>256</option>
                    <option selected>320</option>
                    <option>512</option>
                </select>
            </div>
            <div class="row" style="align-items:start"><label>เลือกสนาม</label>
                <div class="chips" id="chips"></div>
            </div>
            <div class="controls">
                <button id="btnGen">สร้าง QR ของสนามที่เลือก</button>
                <button id="btnGenAll">สร้างชุด QR ทุกสนาม</button>
            </div>
        </section>

        <section class="card">
            <h2>คิวอาร์ที่สร้าง</h2>
            <div id="qrContainer" class="grid-qr"></div>
        </section>
        <div class="chips" id="chips">
            <span class="chip selected" data-k="all">ทั้งหมด</span>
            <span class="chip" data-k="badminton_outdoor">แบดฯ กลางแจ้ง</span>
            <span class="chip" data-k="badminton_dome">แบดฯ ในโดม</span>
            <span class="chip" data-k="tennis">เทนนิส</span>
            <span class="chip" data-k="basketball">บาสเก็ตบอล</span>
            <span class="chip" data-k="pool">สระว่ายน้ำ</span>
            <span class="chip" data-k="petanque">เปตอง</span>
            <span class="chip" data-k="futsal">ฟุตซอล</span>
            <span class="chip" data-k="track">ลู่-ลาน</span>
            <span class="chip" data-k="volleyball">วอลเลย์บอล</span>
            <span class="chip" data-k="sepak_takraw">เซปักตะกร้อ</span>
        </div>
    </main>

    <script>
        const FAC = {
            badminton_outdoor: 'แบดมินตันกลางแจ้ง',
            badminton_dome: 'แบดมินตันในโดม',
            tennis: 'เทนนิส',
            basketball: 'บาสเก็ตบอล',
            pool: 'สระว่ายน้ำ',
            petanque: 'เปตอง',
            futsal: 'ฟุตซอล',
            track: 'ลู่-ลาน',
            volleyball: 'วอลเลย์บอล',
            sepak_takraw: 'เซปักตะกร้อ'
        };

        const $ = (s, p = document) => p.querySelector(s); const $$ = (s, p = document) => Array.from(p.querySelectorAll(s));
        const id = (k) => document.getElementById(k);

        // ค่าตั้งต้น
        const today = new Date();
        id('session').value = today.toISOString().slice(0, 10);
        id('base').value = location.origin; // เดาตามที่เปิดหน้า

        // วาดชิปสนาม
        const chipWrap = id('chips');
        let selected = FACILITIES[0].k;
        FACILITIES.forEach(f => {
            const sp = document.createElement('span'); sp.className = 'chip'; sp.dataset.k = f.k; sp.textContent = f.name; chipWrap.appendChild(sp);
            sp.addEventListener('click', () => { selected = f.k; $$('.chip').forEach(x => x.classList.remove('selected')); sp.classList.add('selected'); });
        });
        $$('.chip')[0].classList.add('selected');

        // สร้างกล่อง QR เปล่า
        const qrContainer = id('qrContainer');
        function ensureBoxes() {
            if (qrContainer.children.length) return;
            FACILITIES.forEach(f => {
                const box = document.createElement('div'); box.className = 'qrbox';
                box.innerHTML = `<div class="qr-title">${f.name}</div><div id="qr-${f.k}"></div>
          <button class="dl" data-k="${f.k}">ดาวน์โหลด</button>
          <div class="hint" id="url-${f.k}">–</div>`;
                qrContainer.appendChild(box);
            });
            $$('.dl').forEach(btn => btn.addEventListener('click', () => download(id('qr-' + btn.dataset.k), `qr-${btn.dataset.k}.png`)));
        }
        ensureBoxes();

        function dataURLOf(container) {
            const img = container.querySelector('img'); const canvas = container.querySelector('canvas');
            return img?.src || canvas?.toDataURL('image/png') || null;
        }
        function download(container, filename) {
            const data = dataURLOf(container); if (!data) return alert('ไม่มีภาพ');
            const a = document.createElement('a'); a.href = data; a.download = filename; a.click();
        }

        function buildUrl(base, facility, session) {
            const u = new URL('/checkin', base || location.origin);
            u.searchParams.set('facility', facility);
            u.searchParams.set('session', session); // YYYY-MM-DD
            return u.toString();
        }

        function renderQR(container, text, size) {
            container.innerHTML = ''; new QRCode(container, { text, width: size, height: size, correctLevel: QRCode.CorrectLevel.M });
        }

        function genOne(key) {
            const base = id('base').value.trim() || location.origin;
            const session = id('session').value; const size = parseInt(id('size').value, 10) || 320;
            const url = buildUrl(base, key, session);
            renderQR(id('qr-' + key), url, size); id('url-' + key).textContent = url;
        }

        id('btnGen').addEventListener('click', () => genOne(selected));
        id('btnGenAll').addEventListener('click', () => FACILITIES.forEach(f => genOne(f.k)));

        // เรนเดอร์ชุดแรกตอนโหลด
        FACILITIES.forEach(f => genOne(f.k));
    </script>
</body>

</html>