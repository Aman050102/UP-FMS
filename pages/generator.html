<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon -->
  <link rel="icon" href="../../img/Logo_of_University_of_Phayao.svg.png" type="image/png">

  <title>สร้างคิวอาร์เข้าเลือกสนาม (QR เดียว)</title>
  <meta name="color-scheme" content="light dark">

  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

  <style>
    :root {
      --brand: #6f4ab4;
      --bg: #f7f6fb;
      --card: #fff;
      --text: #1b1a21;
      --muted: #6f6a7a;
      --divider: #e9e6f0;
      --ring: rgba(111, 74, 180, .18);
      --shadow-sm: 0 3px 12px rgba(23, 16, 48, .08);
      --shadow-md: 0 14px 32px rgba(23, 16, 48, .12);
      --radius-lg: 22px;
      --radius-md: 14px;
    }

    * { box-sizing: border-box }

    html, body {
      height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans Thai", Roboto, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, var(--brand) 0 76px, var(--bg) 76px 100%);
    }

    header {
      height: 76px; display: flex; align-items: center;
      padding: 0 18px; color: #fff; font-weight: 900;
    }

    .wrap {
      min-height: calc(100vh - 76px);
      padding: 24px;
      display: grid;
      gap: 24px;
      grid-template-columns: 1fr 1fr;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 22px; width: 100%;
    }

    h1 { font-size: 22px; margin: 0 0 8px }

    .hint { color: var(--muted); font-size: 14px; margin: 0 }

    .grid {
      display: grid; gap: 14px;
      grid-template-columns: minmax(180px, 220px) 1fr;
      align-items: center; margin-top: 14px;
    }

    @media (max-width:960px) { .wrap { grid-template-columns: 1fr; } }
    @media (max-width:760px) { .grid { grid-template-columns: 1fr } }

    input, select, button {
      padding: 12px 14px; border: 1px solid var(--divider);
      border-radius: var(--radius-md); font-weight: 700; background: #fff;
    }
    input, select {
      width: 100%; outline: none; transition: border-color .15s, box-shadow .15s;
    }
    input:focus, select:focus { border-color: #b9ace8; box-shadow: 0 0 0 5px var(--ring); }

    .row-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

    .btn {
      cursor: pointer; background: #fff;
      transition: transform .05s, box-shadow .15s, background .15s;
      box-shadow: var(--shadow-sm);
    }
    .btn:hover { background: #faf9fd }
    .btn:active { transform: translateY(1px) }
    .btn.primary { background: linear-gradient(180deg, #7b57c6, #6f4ab4); color: #fff; border: 0; }
    .btn.primary:hover { filter: brightness(.98) }
    .btn.ghost { background: #fff }

    .qr-wrap { display: grid; gap: 12px }
    .qrbox {
      display: grid; place-items: center; background: #fff;
      border: 1px dashed var(--divider); border-radius: 16px;
      padding: 16px; min-height: 340px;
    }

    .url-line { display: flex; gap: 10px; align-items: center; flex-wrap: wrap }
    .url-view {
      flex: 1 1 auto; min-width: 240px;
      background: #faf9fd; border: 1px solid var(--divider);
      border-radius: 12px; padding: 10px 12px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 12px; font-weight: 800; color: #4f4a60;
      background: #efeafd; border: 1px solid #dcd3fb;
      border-radius: 999px; padding: 6px 10px;
    }
    .ok { color: #1b8f2d; font-weight: 800 }
    .err { color: #b42318; font-weight: 800 }

    @media (prefers-color-scheme:dark) {
      :root {
        --bg: #1f1a29; --card: #221d2e; --text: #f6f1ff;
        --muted: #c9c2d2; --divider: #3a304b; --ring: rgba(129, 109, 206, .28);
      }
      .url-view { background: #2a2338 }
      .btn.ghost { background: #2a2338 }
    }
  </style>
</head>

<body>
  <header>สร้างคิวอาร์ (ไป choose.html)</header>

  <main class="wrap">
    <!-- ซ้าย: ฟอร์ม -->
    <section class="card">
      <h1>คิวอาร์เดียว → เปิดหน้าเลือกสนาม</h1>
      <p class="hint">QR นี้ชี้ไปที่ <code>/choose.html?session=YYYY-MM-DD</code> ผู้ใช้เลือกสนามแล้วระบบจะบันทึกแบบเงียบ</p>

      <div class="grid">
        <label for="base">Base URL</label>
        <input id="base" type="url" placeholder="https://sports.up.ac.th" inputmode="url" autocomplete="url">
      </div>
      <div class="grid">
        <label for="session">วันที่ (session)</label>
        <input id="session" type="date">
      </div>
      <div class="grid">
        <label for="size">ขนาดภาพ (px)</label>
        <select id="size">
          <option>256</option>
          <option selected>320</option>
          <option>512</option>
        </select>
      </div>

      <div class="row-actions">
        <button id="btnGen" class="btn primary" type="button">สร้าง / อัปเดต QR</button>
        <button id="btnDL" class="btn ghost" type="button">ดาวน์โหลด PNG</button>
        <button id="btnCopy" class="btn ghost" type="button">คัดลอกลิงก์</button>
      </div>
    </section>

    <!-- ขวา: พรีวิว -->
    <section class="card">
      <h1 style="display:flex;align-items:center;gap:8px;margin:0 0 10px">
        พรีวิวคิวอาร์ <span id="status" class="badge" aria-live="polite">พร้อม</span>
      </h1>
      <div class="qr-wrap">
        <div class="qrbox">
          <div id="qr" role="img" aria-label="ตัวอย่างคิวอาร์โค้ด"></div>
        </div>
        <div class="url-line">
          <div id="url" class="url-view" title=""></div>
          <a id="open" class="btn ghost" target="_blank" rel="noopener noreferrer" href="#">เปิดลิงก์</a>
        </div>
      </div>
    </section>
  </main>

  <script>
    const id = k => document.getElementById(k);

    // เติมค่าเริ่มต้น
    (function initDefaults() {
      const savedBase = localStorage.getItem('qr_base');
      const savedSession = localStorage.getItem('qr_session');
      const savedSize = localStorage.getItem('qr_size');

      id('base').value = savedBase || location.origin;
      id('session').value = savedSession || new Date().toISOString().slice(0, 10);
      id('size').value = savedSize || '320';
    })();

    function savePrefs() {
      localStorage.setItem('qr_base', id('base').value.trim());
      localStorage.setItem('qr_session', id('session').value);
      localStorage.setItem('qr_size', id('size').value);
    }

    function normalizeBase(base) {
      // ตัดช่องว่าง, ถ้าไม่มี protocol ใส่ https:// ให้
      let b = (base || '').trim();
      if (!b) return '';
      if (!/^https?:\/\//i.test(b)) b = 'https://' + b;
      // ลบ # และ query ทิ้ง
      try {
        const u = new URL(b);
        u.hash = ''; u.search = '';
        return u.toString().replace(/\/+$/, ''); // ตัด / ท้าย
      } catch { return ''; }
    }

    function buildChooseUrl(base, session) {
      const safeBase = normalizeBase(base);
      if (!safeBase) return '';
      try {
        const u = new URL('/choose.html', safeBase + '/');
        if (session) u.searchParams.set('session', session);
        return u.toString();
      } catch { return ''; }
    }

    function setStatus(ok, msg) {
      const el = id('status');
      el.textContent = msg || (ok ? 'พร้อม' : 'ตรวจสอบค่า');
      el.className = 'badge ' + (ok ? 'ok' : 'err');
    }

    function renderQR(text, size) {
      const box = id('qr');
      box.innerHTML = '';
      if (!text) {
        setStatus(false, 'Base URL ไม่ถูกต้อง');
        id('url').textContent = '';
        id('url').title = '';
        id('open').href = '#';
        id('open').style.pointerEvents = 'none';
        return;
      }
      new QRCode(box, { text, width: size, height: size, correctLevel: QRCode.CorrectLevel.M });
      id('url').textContent = text;
      id('url').title = text;
      id('open').href = text;
      id('open').style.pointerEvents = 'auto';
      setStatus(true, 'ลิงก์พร้อมใช้งาน');
    }

    function gen() {
      savePrefs();
      const base = id('base').value;
      const session = id('session').value;
      const size = parseInt(id('size').value, 10) || 320;
      const url = buildChooseUrl(base, session);
      renderQR(url, size);
    }

    function downloadPNG() {
      const img = id('qr').querySelector('img');
      const canvas = id('qr').querySelector('canvas');
      const data = img?.src || canvas?.toDataURL('image/png');
      if (!data) {
        alert('ยังไม่มีภาพ QR');
        return;
      }
      const nameDate = (id('session').value || 'session').replaceAll(/[^0-9\-]/g, '');
      const a = document.createElement('a');
      a.href = data;
      a.download = `qr-choose-${nameDate}.png`;
      a.click();
    }

    async function copyLink() {
      const txt = id('url').textContent.trim();
      if (!txt) return;
      try {
        await navigator.clipboard.writeText(txt);
        setStatus(true, 'คัดลอกลิงก์แล้ว');
        setTimeout(() => setStatus(true, 'ลิงก์พร้อมใช้งาน'), 1200);
      } catch {
        setStatus(false, 'คัดลอกไม่สำเร็จ');
      }
    }

    // events
    ['base', 'session', 'size'].forEach(k => {
      id(k).addEventListener('input', gen);
      id(k).addEventListener('change', gen);
    });
    id('btnGen').addEventListener('click', gen);
    id('btnDL').addEventListener('click', downloadPNG);
    id('btnCopy').addEventListener('click', copyLink);

    // สร้างครั้งแรก
    window.addEventListener('load', gen);
  </script>
</body>
</html>