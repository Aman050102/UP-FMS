<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>สร้างคิวอาร์เข้าใช้สนาม (นับจำนวนอย่างเดียว)</title>
  <meta name="color-scheme" content="light dark">
  <link rel="icon" href="./favicon.png" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      /* Palette */
      --purple: #6f4ab4;
      --bg: #f7f6fb;
      --card: #fff;
      --text: #1b1a21;
      --muted: #69637a;
      --divider: #e8e4ee;
      /* Accents (ถ้าจะใช้แต้มสีเฉพาะสนาม) */
      --outdoor: #2e7d32;
      --badminton: #1565c0;
      --pool: #0f766e;
      --track: #ef6c00;
      /* Shadows */
      --shadow-sm: 0 2px 10px rgba(24, 16, 48, .05);
      --shadow-md: 0 8px 28px rgba(24, 16, 48, .1);
      /* Type & Radius */
      --fs-base: 16px;
      --fs-sm: 14px;
      --fs-lg: 18px;
      --lh: 1.6;
      --radius-lg: 22px;
      --radius-md: 14px;
      --radius-sm: 10px;
      /* Spacing */
      --space-1: 6px;
      --space-2: 10px;
      --space-3: 14px;
      --space-4: 18px;
      --space-5: 24px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans Thai", Roboto, Arial, sans-serif;
      font-size: var(--fs-base);
      line-height: var(--lh);
      color: var(--text);
      background: linear-gradient(180deg, var(--purple) 0 72px, var(--bg) 72px 100%);
    }

    .topbar {
      height: 72px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 var(--space-4);
      color: #fff;
      font-weight: 900
    }

    main {
      padding: var(--space-4);
      display: grid;
      gap: var(--space-4);
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--space-5);
    }

    .row {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: var(--space-3);
      align-items: center;
      margin-bottom: var(--space-3);
    }

    .hint {
      color: var(--muted);
      font-size: var(--fs-sm)
    }

    input[type="text"],
    input[type="date"],
    select {
      padding: 12px 14px;
      border: 1px solid var(--divider);
      border-radius: var(--radius-md);
      font-weight: 600;
      background: #fff;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: #b8a9e6;
      box-shadow: 0 0 0 4px rgba(111, 74, 180, .15);
    }

    .controls {
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
      margin-top: var(--space-2);
    }

    button {
      appearance: none;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--divider);
      background: #fff;
      font-weight: 800;
      cursor: pointer;
      transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
    }

    button:hover {
      box-shadow: var(--shadow-sm);
      background: #faf9fd
    }

    button:active {
      transform: translateY(1px)
    }

    .chips {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap
    }

    .chip {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--divider);
      cursor: pointer;
      font-weight: 700;
      background: #fff;
      color: #3a3650;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
      user-select: none;
    }

    .chip:hover {
      background: #faf9fd;
      box-shadow: var(--shadow-sm)
    }

    .chip.selected {
      outline: none;
      border-color: #b8a9e6;
      box-shadow: 0 0 0 4px rgba(111, 74, 180, .18)
    }

    .grid-qr {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3)
    }

    .qrbox {
      background: #fff;
      border: 1px solid var(--divider);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      display: grid;
      gap: var(--space-2);
      box-shadow: var(--shadow-sm)
    }

    .qr-title {
      font-weight: 800;
      text-align: center;
      font-size: var(--fs-lg)
    }

    .qrbox .hint {
      text-wrap: pretty;
      word-break: break-all
    }

    @media (max-width:980px) {
      .row {
        grid-template-columns: 1fr
      }

      .grid-qr {
        grid-template-columns: 1fr
      }

      main {
        padding: var(--space-3)
      }
    }

    @media (prefers-color-scheme:dark) {
      :root {
        --bg: #1f1a29;
        --card: #221d2e;
        --text: #f6f1ff;
        --muted: #c7bfd3;
        --divider: #3a304b
      }

      .chip {
        background: #28203a;
        color: #eff0f6
      }

      .chip:hover {
        background: #2d2442
      }

      .chip.selected {
        border-color: #7056c9;
        box-shadow: 0 0 0 4px rgba(129, 109, 206, .28)
      }

      .qrbox {
        background: #241e33
      }

      .qr-title {
        color: #fff
      }

      button {
        background: #2a2338
      }
    }
  </style>
</head>

<body>
  <header class="topbar" aria-label="University Bar">
    <div class="brand-small" aria-label="DQSD logo small">
      <span><img src="/img/logo-dsa.png" alt="DQSD" height="50"></span>
    </div>
  </header>

  <main>
    <section class="card">
      <p class="hint">สแกนแล้วจะไปที่ <code>/checkin</code> ของเซิร์ฟเวอร์ จากนั้นบันทึกจำนวนและเวลาเข้า</p>

      <div class="row">
        <label for="base">Base URL</label>
        <input id="base" type="text" placeholder="https://sports.up.ac.th" />
      </div>

      <!-- ชิปเลือกสนาม (รายการเดียวพอ) -->
      <div class="chips" id="chips"></div>

      <div class="row">
        <label for="session">วันที่ (session)</label>
        <input id="session" type="date" />
      </div>

      <div class="row">
        <label for="size">ขนาดภาพ (px)</label>
        <select id="size">
          <option>256</option>
          <option selected>320</option>
          <option>512</option>
        </select>
      </div>

      <div class="controls">
        <button id="btnGen">สร้าง QR ของสนามที่เลือก</button>
        <button id="btnGenAll">สร้างชุด QR ทุกสนาม</button>
      </div>
    </section>

    <section class="card">
      <h2>คิวอาร์ที่สร้าง</h2>
      <div id="qrContainer" class="grid-qr"></div>
    </section>
  </main>

  <script>
    // รายชื่อสนาม (key -> ชื่อไทย)
    const FAC = {
      badminton_outdoor: 'แบดมินตันกลางแจ้ง',
      badminton_dome: 'แบดมินตันในโดม',
      tennis: 'เทนนิส',
      basketball: 'บาสเก็ตบอล',
      pool: 'สระว่ายน้ำ',
      petanque: 'เปตอง',
      futsal: 'ฟุตซอล',
      track: 'ลู่-ลาน',
      volleyball: 'วอลเลย์บอล',
      sepak_takraw: 'เซปักตะกร้อ'
    };
    // แปลงเป็นลิสต์ที่มี k/name ใช้งานง่าย
    const FACILITIES = Object.entries(FAC).map(([k, name]) => ({ k, name }));

    const $ = (s, p = document) => p.querySelector(s);
    const $$ = (s, p = document) => Array.from(p.querySelectorAll(s));
    const id = k => document.getElementById(k);

    // ค่าตั้งต้น
    const today = new Date();
    id('session').value = today.toISOString().slice(0, 10);
    id('base').value = location.origin;

    // วาดชิปสนาม (ใช้ชุดเดียว)
    const chipWrap = id('chips');
    let selected = FACILITIES[0].k;
    FACILITIES.forEach((f, idx) => {
      const sp = document.createElement('span');
      sp.className = 'chip' + (idx === 0 ? ' selected' : '');
      sp.dataset.k = f.k; sp.textContent = f.name;
      sp.addEventListener('click', () => {
        selected = f.k;
        $$('#chips .chip').forEach(x => x.classList.remove('selected'));
        sp.classList.add('selected');
      });
      chipWrap.appendChild(sp);
    });

    // กล่อง QR
    const qrContainer = id('qrContainer');
    function ensureBoxes() {
      if (qrContainer.children.length) return;
      FACILITIES.forEach(f => {
        const box = document.createElement('div'); box.className = 'qrbox';
        box.innerHTML = `
          <div class="qr-title">${f.name}</div>
          <div id="qr-${f.k}"></div>
          <button class="dl" data-k="${f.k}">ดาวน์โหลด</button>
          <div class="hint" id="url-${f.k}">–</div>
        `;
        qrContainer.appendChild(box);
      });
      $$('.dl').forEach(btn => btn.addEventListener('click', () =>
        download(id('qr-' + btn.dataset.k), `qr-${btn.dataset.k}.png`)
      ));
    }
    ensureBoxes();

    function dataURLOf(container) {
      const img = container.querySelector('img');
      const canvas = container.querySelector('canvas');
      return img?.src || canvas?.toDataURL('image/png') || null;
    }
    function download(container, filename) {
      const data = dataURLOf(container);
      if (!data) return alert('ไม่มีภาพ');
      const a = document.createElement('a');
      a.href = data; a.download = filename; a.click();
    }

    function buildUrl(base, facility, session) {
      const u = new URL('/checkin', base || location.origin);
      u.searchParams.set('facility', facility);
      u.searchParams.set('session', session); // YYYY-MM-DD
      return u.toString();
    }

    function renderQR(container, text, size) {
      container.innerHTML = '';
      new QRCode(container, { text, width: size, height: size, correctLevel: QRCode.CorrectLevel.M });
    }

    function genOne(key) {
      const base = id('base').value.trim() || location.origin;
      const session = id('session').value;
      const size = parseInt(id('size').value, 10) || 320;
      const url = buildUrl(base, key, session);
      renderQR(id('qr-' + key), url, size);
      id('url-' + key).textContent = url;
    }

    id('btnGen').addEventListener('click', () => genOne(selected));
    id('btnGenAll').addEventListener('click', () => FACILITIES.forEach(f => genOne(f.k)));

    // เรนเดอร์ชุดแรกตอนโหลด (สร้างทั้งหมดให้พร้อมดาวน์โหลด)
    FACILITIES.forEach(f => genOne(f.k));
  </script>
</body>

</html>