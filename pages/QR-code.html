<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Logo -->
    <link rel="icon" href="../../img/Logo_of_University_of_Phayao.svg.png" type="image/icon type">

    <title>สร้างคิวอาร์เข้าใช้สนาม (URL + SSO)</title>
    <meta name="color-scheme" content="light dark">

    <link rel="stylesheet" href="../../assets/css/QR-code.css">
    <script src="../../js/QR-code.js" defer></script>

    <!-- Stylesheets -->
    <link rel="Stylesheets" href="/assets /css/">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

</head>

<body>
    <header class="topbar" aria-label="University Bar">
        <div class="brand-small" aria-label="DQSD logo small">
            <!-- <span class="brand-mark" aria-hidden="true"></span> -->
            <span> <img src="../../img/logo-dsq.png" alt="DQSD" height=50"> </span>
        </div>
    </header>

    <main>
        <div class="grid">
            <section class="card">
                <h2>ตั้งค่าลิงก์ปลายทาง</h2>
                <p class="hint">รูปแบบลิงก์:
                    <code>https://your.domain/checkin?facility=...&session=YYYY-MM-DD&nonce=...</code> •
                    นักศึกษาสแกนแล้วจะเด้งไปหน้า SSO เข้าสู่ระบบ และระบบจะดึงอีเมล/โปรไฟล์มาบันทึก
                </p>
                <div class="form">
                    <div class="row">
                        <label for="base">Base URL (ปลายทางเช็คอิน)</label>
                        <input id="base" type="text" placeholder="https://sports.up.ac.th/checkin"
                            value="https://example.com/checkin" />
                    </div>
                    <div class="row">
                        <label for="session">วันที่ใช้งาน (session)</label>
                        <input id="session" type="date" />
                    </div>
                    <div class="row">
                        <label>ขนาดภาพ (px)</label>
                        <select id="size">
                            <option>256</option>
                            <option selected>320</option>
                            <option>512</option>
                        </select>
                    </div>
                    <div class="row">
                        <label>ประเภทสนาม</label>
                        <div class="chips" id="chips">
                            <span class="chip" data-k="outdoor"
                                style="background:#eaf4ec; color:var(--outdoor)">สนามกลางแจ้ง</span>
                            <span class="chip" data-k="badminton"
                                style="background:#e7f0fb; color:var(--badminton)">แบดมินตัน</span>
                            <span class="chip" data-k="pool"
                                style="background:#e7f7f6; color:var(--pool)">สระว่ายน้ำ</span>
                            <span class="chip" data-k="track"
                                style="background:#fff1e6; color:var(--track)">ลู่-ลาน</span>
                        </div>
                    </div>
                    <div class="controls">
                        <button id="btnGen">สร้าง QR ของสนามที่เลือก</button>
                        <button id="btnGenAll">สร้างชุด QR สำหรับทุกสนาม</button>
                    </div>
                </div>
            </section>

            <aside class="card">
                <h2>ตัวอย่างโค้ดฝั่งเซิร์ฟเวอร์ (เช็คอิน)</h2>
                <p class="hint">รองรับ SSO: ถ้าไม่ล็อกอินให้ redirect ไป SSO ก่อน แล้วกลับมาที่ <code>/checkin</code>
                    พร้อมข้อมูลผู้ใช้ (email, name, faculty)</p>
                <pre
                    style="overflow:auto; font-size:12px; background:#0b1020; color:#eaeefb; padding:10px; border-radius:10px">// Node/Express (ตัวอย่างอย่างย่อ)
app.get('/checkin', ensureAuth, async (req, res) => {
  // ข้อมูลผู้ใช้จาก SSO
  const user = { email: req.user.email, name: req.user.name, faculty: req.user.faculty, studentId: req.user.studentId };
  const { facility, session, nonce } = req.query;
  // TODO: ตรวจสอบ facility, รูปแบบวันที่, nonce (single-use / หมดอายุ)
  await db.checkins.insert({ ts: new Date(), facility, session, user, ip: req.ip, ua: req.headers['user-agent'], nonce });
  res.redirect(`/success?facility=${facility}&session=${session}`);
});

function ensureAuth(req, res, next){
  if(req.isAuthenticated?.()) return next();
  // บันทึก target แล้วไป SSO
  req.session.returnTo = req.originalUrl;
  return res.redirect('/sso/login');
}
</pre>
                <p class="hint">ควรมี <strong>nonce</strong> (โทเค็นสุ่ม) แบบใช้ครั้งเดียว/หมดอายุ
                    เพื่อกันการแชร์ลิงก์ย้อนหลัง</p>
            </aside>
        </div>

        <section class="card">
            <h2>คิวอาร์ที่สร้าง</h2>
            <div class="grid-qr">
                <div class="qrbox">
                    <div class="qr-title">สนามกลางแจ้ง</div>
                    <div id="qr-outdoor"></div><button data-k="outdoor" class="dl">ดาวน์โหลด</button>
                    <div class="hint" id="url-outdoor">–</div>
                </div>
                <div class="qrbox">
                    <div class="qr-title">แบดมินตัน</div>
                    <div id="qr-badminton"></div><button data-k="badminton" class="dl">ดาวน์โหลด</button>
                    <div class="hint" id="url-badminton">–</div>
                </div>
                <div class="qrbox">
                    <div class="qr-title">สระว่ายน้ำ</div>
                    <div id="qr-pool"></div><button data-k="pool" class="dl">ดาวน์โหลด</button>
                    <div class="hint" id="url-pool">–</div>
                </div>
                <div class="qrbox">
                    <div class="qr-title">ลู่-ลาน</div>
                    <div id="qr-track"></div><button data-k="track" class="dl">ดาวน์โหลด</button>
                    <div class="hint" id="url-track">–</div>
                </div>
            </div>
        </section>
    </main>

</body>

</html>