<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Logo -->
    <link rel="icon" href="img/Logo_of_University_of_Phayao.svg.png" type="image/icon type">

    <title>สร้างคิวอาร์เข้าใช้สนาม (URL + SSO)</title>
    <meta name="color-scheme" content="light dark">

    <!-- Stylesheets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --purple: #6f4ab4;
            --bg: #efe8f7;
            --card: #fff;
            --text: #1d1b22;
            --muted: #6a6570;
            --divider: #ece7f3;
            --shadow: 0 10px 30px rgba(55, 36, 107, .12);
            --outdoor: #2e7d32;
            --badminton: #1565c0;
            --pool: #0f766e;
            --track: #ef6c00;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans Thai", Roboto, Arial, sans-serif;
            color: var(--text);
            background: linear-gradient(180deg, var(--purple) 0 80px, var(--bg) 80px 100%)
        }

        /* แถบโลโก้ส่วนบน */
        .topbar {
            height: 90px;
            display: flex;
            align-items: center;
            padding-inline: 18px;
        }

        .brand-small {
            display: flex;
            gap: 10px;
            align-items: center;
            color: #fff;
            font-weight: 700;
            letter-spacing: .3px;
            user-select: none;
        }

        .brand-mark {
            width: 56px;
            height: 32px;
            border-radius: 8px;
            background: #ffffff22;
            display: inline-block;
            position: relative;
            overflow: hidden;
        }

        .brand-mark::before,
        .brand-mark::after {
            content: "";
            position: absolute;
            inset: 0;
            background: conic-gradient(from 45deg, #fff0 0 25%, #fff 0 35%, #fff0 0 60%, #fff 0 70%, #fff0 0);
            opacity: .25
        }

        main {
            min-height: calc(100% - 80px);
            padding: 18px;
            display: grid;
            gap: 18px
        }

        .grid {
            display: grid;
            grid-template-columns: 1.1fr .9fr;
            gap: 18px
        }

        .card {
            background: var(--card);
            border-radius: 22px;
            box-shadow: var(--shadow);
            padding: 16px
        }

        .card h2 {
            margin: 0 0 8px
        }

        .hint {
            color: var(--muted);
            font-size: 13px
        }

        .form {
            display: grid;
            gap: 10px
        }

        .row {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 10px;
            align-items: center
        }

        input[type=text],
        input[type=date],
        select {
            padding: 10px 12px;
            border: 1px solid var(--divider);
            border-radius: 12px;
            font-weight: 600
        }

        .chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .chip {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid var(--divider);
            cursor: pointer;
            font-weight: 700
        }

        .chip.selected {
            outline: 3px solid currentColor;
            outline-offset: 2px
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        button {
            appearance: none;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--divider);
            background: #fff;
            font-weight: 800;
            cursor: pointer
        }

        .grid-qr {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px
        }

        .qrbox {
            background: #fff;
            border: 1px solid var(--divider);
            border-radius: 16px;
            padding: 12px;
            display: grid;
            gap: 8px
        }

        .qr-title {
            font-weight: 800;
            text-align: center
        }

        @media(max-width: 980px) {
            .grid {
                grid-template-columns: 1fr
            }

            .row {
                grid-template-columns: 1fr
            }

            .grid-qr {
                grid-template-columns: 1fr
            }
        }

        @media(prefers-color-scheme:dark) {
            :root {
                --bg: #1f1a29;
                --card: #221d2e;
                --text: #f6f1ff;
                --muted: #c7bfd3;
                --divider: #3a304b
            }

            button {
                background: #2a2338
            }
        }
    </style>
</head>

<body>
    <header class="topbar" aria-label="University Bar">
        <div class="brand-small" aria-label="DQSD logo small">
            <!-- <span class="brand-mark" aria-hidden="true"></span> -->
            <span> <img src="./img/logo-dsq.png" alt="DQSD" height=50"> </span>
        </div>
    </header>

    <main>
        <div class="grid">
            <section class="card">
                <h2>ตั้งค่าลิงก์ปลายทาง</h2>
                <p class="hint">รูปแบบลิงก์:
                    <code>https://your.domain/checkin?facility=...&session=YYYY-MM-DD&nonce=...</code> •
                    นักศึกษาสแกนแล้วจะเด้งไปหน้า SSO เข้าสู่ระบบ และระบบจะดึงอีเมล/โปรไฟล์มาบันทึก
                </p>
                <div class="form">
                    <div class="row">
                        <label for="base">Base URL (ปลายทางเช็คอิน)</label>
                        <input id="base" type="text" placeholder="https://sports.up.ac.th/checkin"
                            value="https://example.com/checkin" />
                    </div>
                    <div class="row">
                        <label for="session">วันที่ใช้งาน (session)</label>
                        <input id="session" type="date" />
                    </div>
                    <div class="row">
                        <label>ขนาดภาพ (px)</label>
                        <select id="size">
                            <option>256</option>
                            <option selected>320</option>
                            <option>512</option>
                        </select>
                    </div>
                    <div class="row">
                        <label>ประเภทสนาม</label>
                        <div class="chips" id="chips">
                            <span class="chip" data-k="outdoor"
                                style="background:#eaf4ec; color:var(--outdoor)">สนามกลางแจ้ง</span>
                            <span class="chip" data-k="badminton"
                                style="background:#e7f0fb; color:var(--badminton)">แบดมินตัน</span>
                            <span class="chip" data-k="pool"
                                style="background:#e7f7f6; color:var(--pool)">สระว่ายน้ำ</span>
                            <span class="chip" data-k="track"
                                style="background:#fff1e6; color:var(--track)">ลู่-ลาน</span>
                        </div>
                    </div>
                    <div class="controls">
                        <button id="btnGen">สร้าง QR ของสนามที่เลือก</button>
                        <button id="btnGenAll">สร้างชุด QR สำหรับทุกสนาม</button>
                    </div>
                </div>
            </section>

            <aside class="card">
                <h2>ตัวอย่างโค้ดฝั่งเซิร์ฟเวอร์ (เช็คอิน)</h2>
                <p class="hint">รองรับ SSO: ถ้าไม่ล็อกอินให้ redirect ไป SSO ก่อน แล้วกลับมาที่ <code>/checkin</code>
                    พร้อมข้อมูลผู้ใช้ (email, name, faculty)</p>
                <pre
                    style="overflow:auto; font-size:12px; background:#0b1020; color:#eaeefb; padding:10px; border-radius:10px">// Node/Express (ตัวอย่างอย่างย่อ)
app.get('/checkin', ensureAuth, async (req, res) => {
  // ข้อมูลผู้ใช้จาก SSO
  const user = { email: req.user.email, name: req.user.name, faculty: req.user.faculty, studentId: req.user.studentId };
  const { facility, session, nonce } = req.query;
  // TODO: ตรวจสอบ facility, รูปแบบวันที่, nonce (single-use / หมดอายุ)
  await db.checkins.insert({ ts: new Date(), facility, session, user, ip: req.ip, ua: req.headers['user-agent'], nonce });
  res.redirect(`/success?facility=${facility}&session=${session}`);
});

function ensureAuth(req, res, next){
  if(req.isAuthenticated?.()) return next();
  // บันทึก target แล้วไป SSO
  req.session.returnTo = req.originalUrl;
  return res.redirect('/sso/login');
}
</pre>
                <p class="hint">ควรมี <strong>nonce</strong> (โทเค็นสุ่ม) แบบใช้ครั้งเดียว/หมดอายุ
                    เพื่อกันการแชร์ลิงก์ย้อนหลัง</p>
            </aside>
        </div>

        <section class="card">
            <h2>คิวอาร์ที่สร้าง</h2>
            <div class="grid-qr">
                <div class="qrbox">
                    <div class="qr-title">สนามกลางแจ้ง</div>
                    <div id="qr-outdoor"></div><button data-k="outdoor" class="dl">ดาวน์โหลด</button>
                    <div class="hint" id="url-outdoor">–</div>
                </div>
                <div class="qrbox">
                    <div class="qr-title">แบดมินตัน</div>
                    <div id="qr-badminton"></div><button data-k="badminton" class="dl">ดาวน์โหลด</button>
                    <div class="hint" id="url-badminton">–</div>
                </div>
                <div class="qrbox">
                    <div class="qr-title">สระว่ายน้ำ</div>
                    <div id="qr-pool"></div><button data-k="pool" class="dl">ดาวน์โหลด</button>
                    <div class="hint" id="url-pool">–</div>
                </div>
                <div class="qrbox">
                    <div class="qr-title">ลู่-ลาน</div>
                    <div id="qr-track"></div><button data-k="track" class="dl">ดาวน์โหลด</button>
                    <div class="hint" id="url-track">–</div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const $ = (s, p = document) => p.querySelector(s); const $$ = (s, p = document) => Array.from(p.querySelectorAll(s));
        const FAC = { outdoor: 'สนามกลางแจ้ง', badminton: 'แบดมินตัน', pool: 'สระว่ายน้ำ', track: 'ลู่-ลาน' };
        const id = (k) => document.getElementById(k);

        // ตั้งค่าวันนี้เป็นค่าเริ่มต้นของ session
        (function setToday() { const d = new Date(); id('session').value = d.toISOString().slice(0, 10); })();

        // เลือกสนาม (ชิป)
        let selected = 'outdoor';
        $$('#chips .chip').forEach(ch => { ch.addEventListener('click', () => { selected = ch.dataset.k; $$('#chips .chip').forEach(x => x.classList.remove('selected')); ch.classList.add('selected'); }); });
        const def = $('#chips .chip'); def && def.click();

        function uuid() { return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)); }

        function buildUrl(base, facility, session) {
            const u = new URL(base || 'https://example.com/checkin');
            u.searchParams.set('facility', facility);
            u.searchParams.set('session', session);
            u.searchParams.set('nonce', uuid()); // ใช้ครั้งเดียว
            return u.toString();
        }

        function renderQR(container, text, size) {
            container.innerHTML = ''; new QRCode(container, { text, width: size, height: size, correctLevel: QRCode.CorrectLevel.M });
        }

        function dataURLOf(container) { const img = container.querySelector('img'); const canvas = container.querySelector('canvas'); return img?.src || canvas?.toDataURL('image/png') || null; }
        function download(container, filename) { const data = dataURLOf(container); if (!data) return alert('ไม่มีภาพ'); const a = document.createElement('a'); a.href = data; a.download = filename; a.click(); }

        function genOne(key) {
            const base = id('base').value.trim(); const session = id('session').value; const size = parseInt(id('size').value, 10) || 320;
            const url = buildUrl(base, key, session);
            renderQR(id('qr-' + key), url, size);
            id('url-' + key).textContent = url;
        }

        id('btnGen').addEventListener('click', () => genOne(selected));
        id('btnGenAll').addEventListener('click', () => ['outdoor', 'badminton', 'pool', 'track'].forEach(genOne));
        $$('.dl').forEach(btn => btn.addEventListener('click', () => download(id('qr-' + btn.dataset.k), `qr-${btn.dataset.k}.png`)));

        // เรนเดอร์ชุดแรกตอนโหลด
        ['outdoor', 'badminton', 'pool', 'track'].forEach(genOne);
    </script>
</body>

</html>