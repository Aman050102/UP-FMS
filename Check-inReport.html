<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>รายงานผู้เข้าใช้สนาม – ดู/ค้นหา/ดาวน์โหลด</title>
  <meta name="color-scheme" content="light dark">
  <!-- Export libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js"></script>
  <style>
    :root{
      --purple:#6f4ab4; --bg:#efe8f7; --card:#fff; --text:#1d1b22; --muted:#6a6570; --divider:#ece7f3; --shadow:0 10px 30px rgba(55,36,107,.12);
      --outdoor:#2e7d32; --badminton:#1565c0; --pool:#0f766e; --track:#ef6c00;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif, system-ui, -apple-system, "Noto Sans Thai", Roboto, Arial, sans-serif; color:var(--text);
      background:linear-gradient(180deg, var(--purple) 0 90px, var(--bg) 90px 100%)}
    header{height:90px; display:flex; align-items:center; padding:0 18px; color:#fff; font-weight:900}
    main{min-height:calc(100% - 90px); padding:18px; display:grid; gap:18px}

    .card{background:var(--card); border-radius:22px; box-shadow:var(--shadow); padding:16px}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input[type="date"], select, input[type="text"], button{padding:10px 12px; border:1px solid var(--divider); border-radius:12px; font-weight:600; background:#fff}
    button{cursor:pointer}

    .chips{display:flex; gap:10px; flex-wrap:wrap}
    .chip{padding:6px 10px; border-radius:999px; border:1px solid var(--divider); cursor:pointer; font-weight:700}
    .chip.selected{outline:3px solid currentColor; outline-offset:2px}

    .grid{display:grid; grid-template-columns: 1fr; gap:14px}
    .stats{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
    .stat{background:#fff; border:1px solid var(--divider); border-radius:16px; padding:12px}
    .stat small{color:var(--muted)} .stat b{font-size:22px}

    table{width:100%; border-collapse:collapse}
    thead th{position:sticky; top:0; background:#f3effa}
    th,td{padding:8px 10px; border-bottom:1px solid var(--divider); text-align:left; font-size:14px}
    tbody tr:hover{background:#faf9fc}

    .table-wrap{max-height:60vh; overflow:auto; border:1px solid var(--divider); border-radius:14px}

    @media(max-width: 980px){ .stats{grid-template-columns:repeat(2,1fr)} }
    @media(prefers-color-scheme:dark){ :root{--bg:#1f1a29; --card:#221d2e; --text:#f6f1ff; --muted:#c7bfd3; --divider:#3a304b} thead th{background:#2d2540} }
    @page { size: A4 portrait; margin: 16mm }
  </style>
</head>
<body>
  <header>รายงานผู้เข้าใช้สนามกีฬา – ม.พะเยา</header>

  <main>
    <section class="card">
      <div class="toolbar">
        <label>ช่วงวันที่: <input type="date" id="from"> - <input type="date" id="to"></label>
        <label>กลุ่ม: 
          <select id="groupBy">
            <option value="none">ไม่จัดกลุ่ม</option>
            <option value="facility">ตามสนาม</option>
            <option value="faculty">ตามคณะ</option>
            <option value="date">ตามวัน (session)</option>
          </select>
        </label>
        <input type="text" id="q" placeholder="ค้นหา ชื่อ/รหัส/คณะ/อีเมล" style="min-width:240px">
        <div class="chips" id="chips">
          <span class="chip selected" data-k="all">ทั้งหมด</span>
          <span class="chip" data-k="outdoor" style="color:var(--outdoor)">สนามกลางแจ้ง</span>
          <span class="chip" data-k="badminton" style="color:var(--badminton)">แบดมินตัน</span>
          <span class="chip" data-k="pool" style="color:var(--pool)">สระว่ายน้ำ</span>
          <span class="chip" data-k="track" style="color:var(--track)">ลู่-ลาน</span>
        </div>
        <span style="flex:1"></span>
        <button id="btnExcel">ดาวน์โหลด Excel</button>
        <button id="btnPDF">ดาวน์โหลด PDF</button>
        <button id="btnDoc">ดาวน์โหลด DOCX</button>
        <button id="btnPrint">พิมพ์/เป็น PDF (เบราว์เซอร์)</button>
      </div>
    </section>

    <section class="card grid">
      <div class="stats">
        <div class="stat"><small>รวมรายการ</small><div><b id="st-total">0</b></div></div>
        <div class="stat"><small>กลางแจ้ง</small><div><b id="st-outdoor">0</b></div></div>
        <div class="stat"><small>แบดมินตัน</small><div><b id="st-badminton">0</b></div></div>
        <div class="stat"><small>สระ/ลู่-ลาน</small><div><b><span id="st-pool">0</span> / <span id="st-track">0</span></b></div></div>
      </div>

      <div class="table-wrap">
        <table id="table">
          <thead>
            <tr>
              <th>เวลา</th>
              <th>วันที่ (session)</th>
              <th>สนาม</th>
              <th>รหัสนิสิต</th>
              <th>ชื่อ-สกุล</th>
              <th>คณะ</th>
              <th>อีเมล</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ========== Helper ==========
    const $ = (s,p=document)=>p.querySelector(s); const $$=(s,p=document)=>Array.from(p.querySelectorAll(s));
    const FAC = {outdoor:'สนามกลางแจ้ง', badminton:'แบดมินตัน', pool:'สระว่ายน้ำ', track:'ลู่-ลาน'};

    function fmtDateTime(iso){ const d=new Date(iso); return d.toLocaleString([], { hour:'2-digit', minute:'2-digit'}); }
    function ymd(d){ return new Date(d).toISOString().slice(0,10); }

    // ========== Data source ==========
    // เปลี่ยน URL นี้ให้ชี้ไป API จริง: /api/checkins?from=YYYY-MM-DD&to=YYYY-MM-DD&facility=...
    async function fetchCheckins(params){
      const qs = new URLSearchParams(params).toString();
      try{
        const res = await fetch('/api/checkins?'+qs);
        if(res.ok){ return await res.json(); }
      }catch(e){ /* ignore and fallback */ }
      // fallback demo: ดึงจาก localStorage (ข้อมูลที่หน้าแสกนบันทึกไว้)
      const list = [];
      for(let i=0;i<7;i++){
        const d = new Date(); d.setDate(d.getDate()-i);
        const key = `facility-checkins:${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        try{ list.push(...JSON.parse(localStorage.getItem(key)||'[]')); }catch{}
      }
      // map เป็นรูปแบบเดียวกับ API จริง
      return list.map(r=>({
        ts: new Date(r.ts).toISOString(),
        session_date: (new Date(r.ts)).toISOString().slice(0,10),
        facility: r.facility,
        student_id: r.student?.id || '',
        name_full: r.student?.name || '',
        faculty: r.student?.faculty || '',
        email: ''
      }));
    }

    // ========== State ==========
    let allRows = []; let filtered = []; let facilityFilter = 'all';

    async function load(){
      const from = $('#from').value || ymd(new Date());
      const to   = $('#to').value   || ymd(new Date());
      allRows = await fetchCheckins({from,to,facility: facilityFilter==='all'?'':facilityFilter});
      applyFilters();
    }

    function applyFilters(){
      const q = $('#q').value.trim().toLowerCase();
      filtered = allRows.filter(r=>{
        let okFacility = facilityFilter==='all' || r.facility===facilityFilter;
        let okQuery = !q || [r.student_id,r.name_full,r.faculty,r.email,FAC[r.facility]].join(' ').toLowerCase().includes(q);
        return okFacility && okQuery;
      });
      render();
    }

    function render(){
      // stats
      $('#st-total').textContent = filtered.length;
      const agg = {outdoor:0,badminton:0,pool:0,track:0};
      filtered.forEach(r=>{ if(agg[r.facility]!=null) agg[r.facility]++; });
      Object.keys(agg).forEach(k=> $('#st-'+k) && ($('#st-'+k).textContent = agg[k]));

      // table
      const tb = $('#table tbody'); tb.innerHTML='';
      filtered.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${fmtDateTime(r.ts)}</td>`+
          `<td>${r.session_date}</td>`+
          `<td>${FAC[r.facility]||r.facility}</td>`+
          `<td>${r.student_id}</td>`+
          `<td>${r.name_full}</td>`+
          `<td>${r.faculty}</td>`+
          `<td>${r.email||''}</td>`;
        tb.appendChild(tr);
      });
    }

    // ========== Export ==========
    function rowsForExport(){
      return filtered.map(r=>({
        'เวลา': fmtDateTime(r.ts),
        'วันที่ (session)': r.session_date,
        'สนาม': FAC[r.facility]||r.facility,
        'รหัสนิสิต': r.student_id,
        'ชื่อ-สกุล': r.name_full,
        'คณะ': r.faculty,
        'อีเมล': r.email||''
      }));
    }

    // Excel (xlsx)
    $('#btnExcel').addEventListener('click', ()=>{
      const ws = XLSX.utils.json_to_sheet(rowsForExport());
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Checkins');
      XLSX.writeFile(wb, `checkins_${$('#from').value||''}_${$('#to').value||''}.xlsx`);
    });

    // PDF (A4 portrait)
    $('#btnPDF').addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf; const doc = new jsPDF({orientation:'p', unit:'pt', format:'a4'});
      const data = rowsForExport();
      doc.setFont('Helvetica',''); doc.setFontSize(12);
      doc.text('รายงานผู้เข้าใช้สนามกีฬา (ช่วง '+($('#from').value||'')+' - '+($('#to').value||'')+')', 40, 40);
      const headers = [['เวลา','วันที่ (session)','สนาม','รหัสนิสิต','ชื่อ-สกุล','คณะ','อีเมล']];
      const body = data.map(o=>Object.values(o));
      doc.autoTable({head: headers, body, startY: 60, styles:{fontSize:9}});
      doc.save(`checkins_${$('#from').value||''}_${$('#to').value||''}.pdf`);
    });

    // DOCX
    $('#btnDoc').addEventListener('click', async ()=>{
      const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, HeadingLevel, AlignmentType } = docx;
      const rows = rowsForExport();
      const headerCells = ['เวลา','วันที่ (session)','สนาม','รหัสนิสิต','ชื่อ-สกุล','คณะ','อีเมล'].map(t=> new TableCell({ children:[new Paragraph({ text:t, bold:true })] }));
      const tableRows = [ new TableRow({ children: headerCells }) ];
      rows.forEach(r=>{
        tableRows.push(new TableRow({ children: Object.values(r).map(v=> new TableCell({ children:[new Paragraph(String(v||''))] })) }));
      });
      const table = new Table({ width:{ size:100, type: WidthType.PERCENT }, rows: tableRows });
      const doc = new Document({ sections:[{ properties:{}, children:[ new Paragraph({ text:'รายงานผู้เข้าใช้สนามกีฬา', heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }), new Paragraph('ช่วง '+($('#from').value||'')+' - '+($('#to').value||'')), table ] }] });
      const blob = await Packer.toBlob(doc);
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `checkins_${$('#from').value||''}_${$('#to').value||''}.docx`; a.click();
    });

    // Print
    $('#btnPrint').addEventListener('click', ()=> window.print());

    // ========== Events ==========
    $('#from').value = ymd(new Date()); $('#to').value = ymd(new Date());
    $('#q').addEventListener('input', applyFilters);
    $$('#chips .chip').forEach(ch=> ch.addEventListener('click', ()=>{ $$('#chips .chip').forEach(x=>x.classList.remove('selected')); ch.classList.add('selected'); facilityFilter = ch.dataset.k; load(); }));
    $('#groupBy').addEventListener('change', ()=>{/* ที่ว่างไว้ หากต้องการสรุปกลุ่ม */});

    load();
  </script>
</body>
</html>